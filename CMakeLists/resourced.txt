CMAKE_MINIMUM_REQUIRED (VERSION 2.6)

#CMake doesnt' support same project name for several TARGETS
# libresourced uses it
PROJECT(resource_d)

MACRO(INSTALL_SYMLINK _filepath _sympath)
  GET_FILENAME_COMPONENT(_symname ${_sympath} NAME)
  GET_FILENAME_COMPONENT(_installdir ${_sympath} PATH)

  EXECUTE_PROCESS(COMMAND "${CMAKE_COMMAND}" -E create_symlink
    ${_filepath}
    ${CMAKE_CURRENT_BINARY_DIR}/${_symname})
  INSTALL(FILES ${CMAKE_CURRENT_BINARY_DIR}/${_symname}
    DESTINATION ${_installdir})
ENDMACRO(INSTALL_SYMLINK)

SET(CMAKE_EXTRA_INCLUDE_FILES unistd.h)

INCLUDE_DIRECTORIES(${RESOURCED_INCLUDEDIR}
  ${RESOURCED_SOURCE_DIR}
  ${HEART_SOURCE_DIR}/include
  ${MEMORY_SOURCE_DIR}
  ${PROC-STAT_SOURCE_DIR}/include
  ${APP-STAT_SOURCE_DIR}/include
  ${NETWORK_SOURCE_DIR}/include
  ${BLOCK_SOURCE_DIR}/include
  ${RESOURCED_DBUS_SOURCE_DIR}/include
  ${FREEZER_SOURCE_DIR}/include
)

SET (HEADERS
  ${NETWORK_SOURCE_DIR}/include/datausage-vconf-callbacks.h
  ${NETWORK_SOURCE_DIR}/include/iface-cb.h
  ${INCLUDE_MEMORY_DIR}/helper.h
)
FILE(GLOB FILE "${INCLUDE_COMMON_DIR}/*.h")
FOREACH(HEADER ${FILE})
	SET(HEADERS ${HEADERS} ${HEADER})
ENDFOREACH()

SET (SOURCES
  ${PROC-STAT_SOURCE_DIR}/proc-handler.c
  ${PROC-STAT_SOURCE_DIR}/proc-main.c
  ${PROC-STAT_SOURCE_DIR}/proc-noti.c
  ${PROC-STAT_SOURCE_DIR}/proc-process.c
  ${PROC-STAT_SOURCE_DIR}/proc-monitor.c
  ${PROC-STAT_SOURCE_DIR}/proc-info.c
  ${PROC-STAT_SOURCE_DIR}/proc-appusage.c
  ${PROC-STAT_SOURCE_DIR}/proc-usage-stats.c
  ${PROC-STAT_SOURCE_DIR}/proc-usage-stats-helper.c
  ${SLUGGISH_SOURCE_DIR}/sluggish.c
  ${RESOURCED_SOURCE_DIR}/init.c
  ${RESOURCED_SOURCE_DIR}/main.c
  ${MEMORY_SOURCE_DIR}/helper.c
  ${COMMON_SOURCE_DIR}/procfs.c
  )

FILE(GLOB FILE "${COMMON_SOURCE_DIR}/*.c")
FOREACH(SOURCE ${FILE})
	SET(SOURCES ${SOURCES} ${SOURCE})
ENDFOREACH()

INSTALL(FILES ${DATA_DIR}/${EXCLUDE_LIST_FILE_NAME} DESTINATION /usr/etc)
#network module
IF("${NETWORK_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${NETWORK_SOURCE_DIR}/counter.c
  )
  IF("${DATAUSAGE_TYPE}" STREQUAL "NFACCT")
    SET(CONFIG_DATAUSAGE_NFACCT 1)
    SET(SOURCES ${SOURCES}
      ${NETWORK_SOURCE_DIR}/nfacct-rule.c
      ${NETWORK_SOURCE_DIR}/nf-restriction.c
    )
  ELSE()
    SET(SOURCES ${SOURCES}
      ${NETWORK_SOURCE_DIR}/generic-netlink.c
      ${NETWORK_SOURCE_DIR}/ktgrabber-restriction.c
      ${NETWORK_SOURCE_DIR}/ktgrabber-parser.c
    )
  ENDIF()

  IF("${WEARABLE_NOTI}" STREQUAL "ON")
    SET(SOURCES ${SOURCES}
      ${NETWORK_SOURCE_DIR}/notification-wearable.c
    )
  ELSE()
    SET(SOURCES ${SOURCES}
      ${NETWORK_SOURCE_DIR}/notification-mobile.c
    )
  ENDIF()

  SET(SOURCES ${SOURCES}
    ${NETWORK_SOURCE_DIR}/counter-process.c
    ${NETWORK_SOURCE_DIR}/options-private.c
    ${NETWORK_SOURCE_DIR}/datausage-quota-processing.c
    ${NETWORK_SOURCE_DIR}/datausage-vconf-callbacks.c
    ${NETWORK_SOURCE_DIR}/datausage-vconf-common.c
    ${NETWORK_SOURCE_DIR}/specific-trace.c
    ${NETWORK_SOURCE_DIR}/datausage-common.c
    ${NETWORK_SOURCE_DIR}/iface-cb.c
    ${NETWORK_SOURCE_DIR}/nl-helper.c
    ${NETWORK_SOURCE_DIR}/restriction-handler.c
    ${NETWORK_SOURCE_DIR}/restriction-helper.c
    ${NETWORK_SOURCE_DIR}/restriction-local.c
    ${NETWORK_SOURCE_DIR}/tethering-restriction.c
    ${NETWORK_SOURCE_DIR}/db-guard.c
    )

   INSTALL(FILES ${NETWORK_SOURCE_DIR}/network.conf
		DESTINATION /etc/resourced)
   INSTALL(FILES ${NETWORK_SOURCE_DIR}/500.resourced-datausage.patch.sh
                 DESTINATION /etc/opt/upgrade)

   SET (REQUIRES_LIST ${REQUIRES_LIST}
	openssl
	tapi
   )


ENDIF()


#freezer module
IF("${FREEZER_MODULE}" STREQUAL "ON")
   SET(SOURCES ${SOURCES} ${FREEZER_SOURCE_DIR}/freezer.c)
ELSE()
   SET(SOURCES ${SOURCES} ${FREEZER_SOURCE_DIR}/freezer-common.c)
ENDIF()

#resourced DBus module
SET(SOURCES ${SOURCES}
  ${RESOURCED_DBUS_SOURCE_DIR}/resourced-dbus.c
  )

IF("${VIP_AGENT}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
     ${VIP_SOURCE_DIR}/vip-process.c
    )
ENDIF()

#heart module
IF("${HEART_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${HEART_SOURCE_DIR}/logging.c
    ${HEART_SOURCE_DIR}/heart.c
    ${HEART_SOURCE_DIR}/heart-abnormal.c
    ${HEART_SOURCE_DIR}/heart-cpu.c
    ${HEART_SOURCE_DIR}/heart-memory.c
    ${HEART_SOURCE_DIR}/heart-battery.c
    ${HEART_SOURCE_DIR}/heart-storage.c
    ${HEART_SOURCE_DIR}/decision.c
    ${HEART_SOURCE_DIR}/decision-memory.c
    )
  ADD_DEFINITIONS("-DHEART_SUPPORT")
ENDIF()

#memory module
IF("${MEMORY_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${MEMORY_SOURCE_DIR}/lowmem-dbus.c
    ${MEMORY_SOURCE_DIR}/memcontrol.c
    ${MEMORY_SOURCE_DIR}/vmpressure-lowmem-handler.c
    )
  ADD_DEFINITIONS("-DMEMORY_SUPPORT")
ENDIF()

#swap module
IF("${SWAP_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${SWAP_SOURCE_DIR}/swap.c
    )
  ADD_DEFINITIONS("-DSWAP_SUPPORT")
ENDIF()

IF("${CPU_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${CPU_SOURCE_DIR}/cpu.c
    )
ENDIF()

IF("${TIMER_SLACK}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
    ${TIMER_SOURCE_DIR}/timer-slack.c
    )
ENDIF()

IF("${BLOCK_MODULE}" STREQUAL "ON")
  SET(SOURCES ${SOURCES}
     ${BLOCK_SOURCE_DIR}/block.c
     ${BLOCK_SOURCE_DIR}/block-monitor.c
    )
ENDIF()

SET (REQUIRES_LIST ${REQUIRES_LIST}
	ecore
	dlog
	glib-2.0
        sqlite3
	vconf
	vconf-internal-keys
	ecore-file
	edbus
	eina
	libsystemd-daemon
	leveldb
	eventsystem
)

IF("${HEART_MODULE}" STREQUAL "ON")
  SET (REQUIRES_LIST ${REQUIRES_LIST}
	libsystemd-journal
  )
ENDIF()

INCLUDE(FindPkgConfig)
pkg_check_modules(daemon_pkgs REQUIRED ${REQUIRES_LIST})

FOREACH(flag ${daemon_pkgs_CFLAGS})
        SET(EXTRA_CFLAGS "${EXTRA_CFLAGS} ${flag} -pthread")
ENDFOREACH(flag)

SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${EXTRA_CFLAGS} -fPIE")

CONFIGURE_FILE(${INCLUDE_COMMON_DIR}/config.h.in
  ${INCLUDE_COMMON_DIR}/config.h)

ADD_EXECUTABLE(hashtest ${UTILS_SOURCE_DIR}/hashtest.c)
TARGET_LINK_LIBRARIES(hashtest ${daemon_pkgs_LDFLAGS})

ADD_EXECUTABLE (${PROJECT_NAME} ${HEADERS} ${SOURCES})
TARGET_LINK_LIBRARIES(${PROJECT_NAME}
  ${daemon_pkgs_LDFLAGS} "-pie -lrt -lm -ldl"
)

IF("${NETWORK_MODULE}" STREQUAL "ON")
  TARGET_LINK_LIBRARIES(${PROJECT_NAME}
    resourced
    app-stat
    storage
    settings
    net-cls
    telephony
    net-iface
  )

  IF("${CMAKE_BUILD_TYPE}" STREQUAL  "DEBUG")
	ADD_EXECUTABLE(test-udp-server ${UTILS_SOURCE_DIR}/udp-server.c ${UTILS_SOURCE_DIR}/udp-common.c)
	ADD_EXECUTABLE(test-udp-client ${UTILS_SOURCE_DIR}/udp-client.c ${UTILS_SOURCE_DIR}/udp-common.c)
  ADD_EXECUTABLE(iface-test ${UTILS_SOURCE_DIR}/iface-test.c)
  TARGET_LINK_LIBRARIES(iface-test net-iface ${daemon_pkgs_LDFLAGS})

  ENDIF()

  INSTALL(FILES ${DATA_DIR}/traffic_db.sql
    DESTINATION /usr/share)
ENDIF()

INSTALL(FILES ${INCLUDE_PUBLIC_DIR}/resourced.h DESTINATION include/system)

SET_TARGET_PROPERTIES(${PROJECT_NAME} PROPERTIES SKIP_BUILD_RPATH true)
INSTALL(FILES ${PROJECT_NAME}
  DESTINATION ${MAKE_INSTALL_PREFIX}/usr/bin RENAME resourced
  PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE WORLD_EXECUTE)

IF("${MEMORY_ENG}" STREQUAL "ON")
  INSTALL(FILES ${MEMORY_SOURCE_DIR}/memory_eng.conf
    DESTINATION /etc/resourced RENAME memory.conf)
ELSE()
  INSTALL(FILES ${MEMORY_SOURCE_DIR}/memory_user.conf
    DESTINATION /etc/resourced RENAME memory.conf)
ENDIF()

IF("${SWAP_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${SWAP_SOURCE_DIR}/swap.conf DESTINATION /etc/resourced)
ENDIF()

IF("${HEART_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${HEART_SOURCE_DIR}/heart.conf
    DESTINATION /etc/resourced RENAME heart.conf)
  INSTALL(FILES ${HEART_SOURCE_DIR}/dump_heart_data.sh
    DESTINATION /opt/etc/dump.d/module.d)
ENDIF()

IF("${CPU_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${CPU_SOURCE_DIR}/cpu.conf
    DESTINATION /etc/resourced RENAME cpu.conf)
ELSE()
  INSTALL(PROGRAMS ${CMAKE_BINARY_DIR}/scripts/resourced-cpucgroup.sh DESTINATION bin)
ENDIF()

IF("${TIMER_SLACK}" STREQUAL "ON")
  INSTALL(FILES ${TIMER_SOURCE_DIR}/timer-slack.conf
    DESTINATION /etc/resourced RENAME timer-slack.conf)
ENDIF()

IF("${VIP_AGENT}" STREQUAL "ON")
ADD_EXECUTABLE(vip-release-agent ${VIP_SOURCE_DIR}/vip-release-agent.c)
TARGET_LINK_LIBRARIES(vip-release-agent dlog)
INSTALL(TARGETS vip-release-agent DESTINATION /usr/bin)
INSTALL(FILES ${VIP_SOURCE_DIR}/vip-process.conf DESTINATION /etc/resourced RENAME vip-process.conf)
ENDIF()

IF("${BLOCK_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${BLOCK_SOURCE_DIR}/block.conf
    DESTINATION /etc/resourced RENAME block.conf)
ENDIF()

IF("${FREEZER_MODULE}" STREQUAL "ON")
  INSTALL(FILES ${FREEZER_SOURCE_DIR}/freezer.conf
    DESTINATION /etc/resourced RENAME freezer.conf)
  INSTALL(FILES ${FREEZER_SOURCE_DIR}/libsystem-freezer.so.${ARCH} DESTINATION lib
    RENAME libsystem-freezer.so)
ENDIF()

INSTALL(FILES ${PROC-STAT_SOURCE_DIR}/proc.conf
    DESTINATION /etc/resourced RENAME proc.conf)

IF("${SLP_TESTS}" STREQUAL "ON")
ADD_EXECUTABLE(test-file-helper ${HEADERS}
  ${COMMON_SOURCE_DIR}/file-helper.c
  ${COMMON_SOURCE_DIR}/file-helper.h
  ${TEST_DIR}/test-file-helper.c)
TARGET_LINK_LIBRARIES(test-file-helper ${daemon_pkgs_LDFLAGS})
INSTALL(TARGETS test-file-helper DESTINATION /usr/lib/resourced/test)
ENDIF()

ADD_EXECUTABLE(mem-stress ${HEADERS}
  ${COMMON_SOURCE_DIR}/macro.h
  ${COMMON_SOURCE_DIR}/util.c
  ${COMMON_SOURCE_DIR}/util.h
  ${COMMON_SOURCE_DIR}/config-parser.c
  ${COMMON_SOURCE_DIR}/config-parser.h
  ${CMAKE_SOURCE_DIR}/src/mem-stress/mem-stress.c)
TARGET_LINK_LIBRARIES(mem-stress ${daemon_pkgs_LDFLAGS})
INSTALL(TARGETS mem-stress DESTINATION ${MAKE_INSTALL_PREFIX}/usr/bin)
INSTALL(FILES ${CMAKE_SOURCE_DIR}/src/mem-stress/mem-stress.service
  DESTINATION ${MAKE_INSTALL_PREFIX}/usr/lib/systemd/system)
INSTALL_SYMLINK(../mem-stress.service ${MAKE_INSTALL_PREFIX}/usr/lib/systemd/system/graphical.target.wants/mem-stress.service)
